---
- name: Running minikube
  hosts: azure
  vars_files:
    - azurepass.yml
  pre_tasks:
    
    - name: Check Minikube's status
      command: minikube status
      register: minikube_status
      changed_when: false
      ignore_errors: true
    
    - name: Start Minikube if required
      command: minikube start
      when: "not minikube_status.stdout or 'Running' not in minikube_status.stdout"

        
    - name: delete load vote tar
      file:
        path: vote-app.tar
        state: absent
        
        
    - name: delete load node tar
      file:
        path: node-app.tar
        state: absent
        
    - name: delete load wokrker tar
      file:
        path: worker-app.tar
        state: absent    
    
    
    - name: Copy image tars
      copy:
        src: tars/
        dest: .
        force: yes
        mode:0666
        
    - name: delete load
      file:
        path: loadScript.sh
        state: absent
        
    - name: Copy load script
      copy:
        src: loadScript.sh
        dest: .
        force: yes
        mode: '0777'
        
    - name: delete old img
      shell: "docker rmi -f vasanth-vote-app"
      register: pop
      
      
    - name: Print return information from the previous task
      debug:
        msg: "{{pop.stdout}}"
    
    - name: delete old img
      shell: "docker rmi -f vasanth-node-app"
      register: pop   

    - name: delete old img
      shell: "docker rmi -f vasanth-worker-app"
      register: pop   
      
    - name: Changing environment
      shell: "eval $(minikube docker-env)"
      
    - name: Load images
      command: sh loadScript.sh
      register: op
      
    - name: Print return information from the previous task
      debug:
        msg: "{{op.stdout}}"
      

    - name: Copy Deployment files
      copy:
        src: kubeDepFiles/
        dest: .
  tasks:

    - name: Deploying Redis
      command: kubectl apply -f redis-deployment.yml
      register: depl_output1
      changed_when: " 'unchanged' not in depl_output1.stdout"
    
    - name: Deploying Postgres
      command: kubectl apply -f postgres-deployment.yml
      register: depl_output2
      changed_when: " 'unchanged' not in depl_output2.stdout"

      
    - name: Deploying Python App  
      command: kubectl apply -f vote-app-deployment.yml
      register: depl_output3
      
    - name: Print return information from the previous task
      debug:
        msg: "{{depl_output3.stdout}}"
        
      
    - name: Deploying Node result App
      command: kubectl apply -f result-app-deployment.yml
      register: depl_output4
      
      
    - name: Print return information from the previous task
      debug:
        msg: "{{depl_output4.stdout}}"
        
      
    - name: Deploying Worker App
      command: kubectl apply -f worker-app-deployment.yml
      register: depl_output5
      changed_when: " 'unchanged' not in depl_output5.stdout"
      
    - name: get pod for vote
      command: kubectl get pods -l=app=vote -o=name
      register: votePod
      
    - name: get pod for result
      command: kubectl get pods -l=app=result -o=name
      register: resultPod
      
    - name: port forward for vote app
      command:  kubectl port-forward --address 0.0.0.0 {{votePod.stdout}}  8092:80 
      async: 86400
      poll: 0
      
    - name: port forward for result app
      command:  kubectl port-forward --address 0.0.0.0 {{resultPod.stdout}}  8093:80
      async: 86400
      poll: 0
      
        
